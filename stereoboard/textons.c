/*
 * textons.c
 *
 *  Created on: 16 feb. 2016
 *      Author: Kevin
 */

#include "main_parameters.h"
#include "textons.h"

uint8_t patch_idx_h[n_patches_h];
uint8_t patch_idx_v[n_patches_v];
uint16_t patch_idx[n_patches_h*n_patches_v];
uint8_t n_patches;

q15_t patch[patch_size_h*patch_size_v*3];
//dictionary_kevin_zoo2.dat, probable RGB
//q31_t texton_dict[patch_size_h*patch_size_v*3*n_textons] = {80,87,88,86,91,94,85,93,96,83,87,93,79,79,83,75,79,84,81,82,84,78,82,84,77,79,83,73,73,75,57,61,73,60,62,69,57,62,69,57,62,69,58,61,68,44,48,57,37,44,50,38,41,49,42,45,55,43,49,62,39,42,51,33,37,40,34,32,34,34,34,41,39,40,52,64,64,64,60,60,59,56,53,59,60,59,62,63,62,64,71,70,72,69,67,69,68,64,70,72,70,71,72,70,72,81,80,81,82,81,85,80,81,85,85,85,87,86,85,86,93,93,92,97,97,97,95,95,97,98,97,100,101,101,104,97,99,97,99,103,101,101,103,101,102,101,102,104,104,104,50,56,88,52,58,88,53,62,85,53,59,83,58,60,84,40,43,81,42,48,84,47,50,82,46,49,78,45,51,73,34,38,60,34,39,60,36,41,52,37,42,51,39,43,53,31,35,46,30,34,40,30,34,41,32,36,42,35,42,49,35,36,45,34,35,40,32,35,37,34,37,40,36,39,48,138,101,94,139,105,104,138,104,104,140,104,106,138,104,104,116,93,90,118,102,96,121,103,102,123,104,104,119,104,104,84,83,83,85,82,84,86,85,86,88,86,92,90,87,94,65,65,72,65,65,72,66,66,73,69,71,79,75,77,83,65,63,67,62,61,67,62,61,67,65,64,70,67,69,73,35,34,42,35,36,42,42,43,56,62,61,77,75,76,88,31,32,33,32,32,33,39,40,50,62,62,78,74,76,89,30,32,34,32,31,32,38,40,48,59,60,76,72,78,88,31,34,33,32,34,34,39,41,47,59,62,75,69,72,85,33,36,43,34,35,44,41,43,52,59,60,73,67,69,82,59,61,80,59,59,76,62,62,76,67,68,77,65,67,80,61,66,86,63,62,78,62,63,76,68,66,78,69,69,80,64,67,90,64,67,78,62,65,78,67,66,80,69,67,81,70,73,90,67,70,82,66,69,80,71,70,80,66,68,82,72,77,89,68,70,83,69,71,84,71,71,82,65,70,81,104,109,109,110,118,118,122,122,120,120,120,118,104,104,104,104,112,116,115,125,127,125,128,128,123,127,127,108,111,110,104,113,121,113,126,128,127,129,129,128,127,127,119,122,121,104,114,121,121,127,129,128,129,129,129,128,128,117,118,118,104,112,115,112,119,120,122,123,122,123,122,122,114,115,115,58,66,82,56,65,72,49,57,65,47,54,62,50,54,57,54,63,79,51,60,65,47,56,62,47,56,60,47,51,57,54,61,73,50,58,65,48,55,61,45,55,59,45,52,59,52,60,71,48,58,66,50,56,63,47,55,62,46,50,60,57,61,74,51,60,66,52,58,62,48,56,64,52,53,64,41,40,53,34,35,48,32,32,45,33,34,47,34,36,50,34,37,40,34,33,33,34,32,34,33,32,33,32,34,38,38,41,49,36,40,41,37,39,41,36,39,40,37,40,42,52,55,65,53,53,60,51,51,58,48,48,56,46,48,55,66,67,76,67,69,73,64,66,74,63,65,72,64,64,72,73,72,87,57,59,71,38,39,46,32,32,35,35,31,38,85,85,92,59,59,77,35,35,41,31,29,29,30,30,32,89,94,98,62,61,81,37,33,37,30,29,30,30,30,31,86,95,98,65,65,80,37,36,42,31,29,29,29,30,31,83,87,95,73,73,83,48,47,52,36,35,40,36,35,40,68,78,94,69,81,109,67,79,110,66,78,108,103,104,105,71,80,102,70,82,112,69,81,113,66,81,111,104,104,109,72,84,102,69,82,115,67,82,115,67,81,112,104,104,111,72,82,98,71,83,113,68,82,117,66,81,117,104,104,110,69,78,95,66,80,99,67,80,111,68,82,108,104,104,104,48,53,94,46,51,106,45,51,102,45,51,102,49,51,90,43,48,86,39,46,97,38,46,96,39,46,92,44,47,84,42,47,81,38,45,83,38,45,82,38,45,85,44,45,74,43,49,75,39,46,80,39,45,78,40,46,81,41,46,71,50,55,74,47,50,75,47,50,74,48,51,73,46,50,70,77,72,67,80,71,62,82,71,63,82,73,71,77,72,78,80,72,66,83,72,60,84,72,60,83,73,62,77,75,74,81,72,60,84,71,57,84,70,57,80,70,57,75,73,68,80,73,60,82,71,59,84,70,55,77,67,57,72,69,65,77,74,66,79,69,60,75,68,55,73,65,58,72,67,65,184,122,104,184,132,104,184,132,104,184,132,104,184,132,104,184,123,104,184,132,104,184,132,104,184,132,104,184,132,104,184,132,104,184,132,104,184,132,104,184,132,104,184,132,104,158,103,95,158,104,95,158,104,95,158,104,95,158,104,95,141,103,85,141,103,85,142,103,85,142,103,86,142,103,87,68,72,83,69,72,89,69,73,92,68,71,93,70,70,89,65,68,81,65,68,85,66,67,93,68,68,94,67,71,89,58,61,77,59,59,78,63,63,85,67,64,90,69,68,86,53,53,65,57,54,69,61,58,77,62,59,87,62,65,82,48,51,61,50,53,64,55,55,75,59,59,80,61,64,82,40,42,46,32,30,37,31,32,36,33,33,43,39,41,54,44,47,51,35,39,45,38,40,46,42,44,52,45,52,61,55,61,69,56,60,70,58,61,71,60,61,72,59,61,69,70,73,82,74,80,85,75,79,90,76,80,89,72,73,79,80,82,87,81,85,90,82,86,92,81,89,90,79,82,87,47,51,78,41,45,74,40,48,71,39,49,72,44,53,73,53,57,86,47,53,87,46,51,87,48,54,86,50,54,85,56,59,100,55,56,104,53,57,102,54,58,101,55,59,97,60,64,109,59,61,114,58,60,114,58,59,109,58,61,102,63,67,112,63,64,116,61,64,115,60,62,110,61,62,104,56,52,66,54,54,57,58,54,53,65,57,53,66,60,59,55,55,67,55,54,56,58,56,55,65,58,55,72,62,59,56,56,69,59,56,59,63,60,58,72,64,61,75,66,64,57,57,70,60,57,59,67,63,62,76,68,59,78,71,66,59,60,69,63,60,62,71,66,65,78,74,68,79,75,73,34,37,53,28,29,52,28,29,53,28,28,53,32,34,54,32,33,53,28,28,38,27,27,27,27,28,35,27,29,49,37,35,53,29,28,32,27,27,27,28,27,28,29,27,43,48,46,53,30,28,29,28,28,28,28,27,27,31,28,41,54,54,54,42,42,45,35,33,37,37,34,41,39,38,49,62,71,79,66,72,76,70,74,79,71,77,83,77,83,89,56,60,73,55,62,70,58,67,74,61,69,76,67,76,82,51,57,68,49,58,66,50,57,65,53,60,67,59,66,69,49,56,63,46,54,60,47,55,61,45,59,63,53,63,67,50,59,64,46,56,63,45,57,62,46,58,63,53,61,66,65,54,47,63,52,43,62,51,43,58,48,43,57,50,45,65,52,42,63,51,40,61,50,40,57,49,41,58,49,42,63,49,40,59,49,40,57,48,39,55,48,43,56,46,40,60,49,40,56,48,40,53,45,38,53,47,40,53,45,39,56,49,51,56,48,49,52,44,42,50,44,40,53,47,42,47,51,58,52,54,61,69,72,82,89,90,98,104,104,105,45,48,55,50,53,60,66,73,84,79,83,95,103,105,107,43,47,52,50,53,62,68,74,84,81,86,93,104,108,109,44,47,56,51,55,65,70,77,84,79,86,93,104,105,104,49,54,56,56,59,66,72,76,83,85,88,97,104,103,101,55,59,117,55,61,121,53,59,121,53,59,115,54,57,103,55,59,118,49,56,122,49,55,121,49,55,115,52,53,103,55,59,116,42,52,119,43,51,119,44,51,112,49,52,103,54,59,108,41,50,117,40,50,115,42,50,107,45,50,102,55,59,101,42,50,101,39,49,101,39,49,101,46,49,102,72,75,84,79,83,91,104,104,105,104,110,114,110,116,120,69,73,85,71,75,86,104,104,105,104,109,117,111,122,127,66,75,82,69,76,86,101,104,105,104,112,118,121,126,126,72,76,81,71,78,85,97,104,104,104,110,117,119,124,126,73,76,79,74,78,81,98,104,104,104,108,116,114,118,122,68,71,84,74,76,86,78,77,86,80,84,92,84,89,95,72,71,88,76,79,82,77,82,83,78,85,90,82,84,92,67,68,83,75,78,79,76,79,80,80,81,85,78,83,88,67,67,83,72,75,79,73,77,80,75,78,83,75,74,89,68,69,83,69,69,80,71,72,79,70,70,82,73,74,84,81,91,100,104,104,108,105,113,115,113,122,124,104,110,110,79,86,96,104,107,114,108,119,121,119,125,126,104,116,123,80,87,94,104,105,115,108,119,122,123,126,129,110,121,129,81,86,94,104,104,111,109,119,126,121,127,129,112,121,128,82,89,94,103,103,108,106,114,114,114,118,120,104,111,116,83,83,85,86,91,89,85,87,90,77,79,89,72,72,88,86,86,88,88,97,99,85,91,95,82,85,92,74,75,89,90,91,90,91,100,102,88,92,96,83,83,88,76,78,89,86,89,88,90,97,95,87,92,93,82,85,88,74,75,89,82,79,82,84,85,85,83,83,84,80,80,88,71,70,89,80,85,98,77,84,98,70,73,91,61,60,84,62,63,81,81,85,103,76,84,97,67,71,91,59,58,80,56,59,78,81,85,104,74,84,95,62,66,85,58,60,74,53,56,71,79,84,97,75,83,97,62,65,86,55,58,73,53,56,70,76,81,95,75,83,95,65,67,86,60,61,76,58,59,71,55,60,71,52,57,70,51,56,66,47,54,63,48,52,61,55,61,71,51,56,67,51,57,64,48,55,62,47,54,61,59,64,77,57,61,72,54,61,71,53,58,68,54,57,68,66,70,86,64,69,81,60,68,77,62,67,76,60,67,74,66,76,88,68,76,85,68,74,82,68,76,82,70,74,81,94,94,96,89,90,94,74,74,76,51,50,56,35,34,36,104,106,107,98,103,103,79,78,79,48,47,50,32,33,32,102,104,106,100,103,105,82,83,86,51,50,52,32,33,35,99,102,103,99,102,105,81,84,89,60,59,61,36,35,43,96,95,96,97,98,101,82,85,89,63,65,69,45,44,55};
//reduced dictionary to 24 textons of 24 pixels
q15_t texton_dict[patch_size_h*patch_size_v*3*n_textons] = {80,87,88,86,91,94,85,93,96,83,87,93,79,79,83,75,79,84,81,82,84,78,82,84,79,83,73,73,75,57,61,73,60,62,69,57,62,69,57,62,69,58,61,68,44,48,57,37,44,38,41,49,42,45,55,43,49,62,39,42,51,33,37,40,34,32,34,34,34,41,39,40,52,64,64,60,60,59,56,53,59,60,59,62,63,62,64,71,70,72,69,67,69,68,64,70,72,70,71,70,72,81,80,81,82,81,85,80,81,85,85,85,87,86,85,86,93,93,92,97,97,97,95,95,98,97,100,101,101,104,97,99,97,99,103,101,101,103,101,102,101,102,104,104,104,50,56,88,52,88,53,62,85,53,59,83,58,60,84,40,43,81,42,48,84,47,50,82,46,49,78,45,51,73,38,60,34,39,60,36,41,52,37,42,51,39,43,53,31,35,46,30,34,40,30,34,41,32,36,35,42,49,35,36,45,34,35,40,32,35,37,34,37,40,36,39,48,138,101,94,139,105,104,138,104,140,104,106,138,104,104,116,93,90,118,102,96,121,103,102,123,104,104,119,104,104,84,83,83,82,84,86,85,86,88,86,92,90,87,94,65,65,72,65,65,72,66,66,73,69,71,79,75,77,65,63,67,62,61,67,62,61,67,65,64,70,67,69,73,35,34,42,35,36,42,42,43,56,62,77,75,76,88,31,32,33,32,32,33,39,40,50,62,62,78,74,76,89,30,32,34,32,31,32,40,48,59,60,76,72,78,88,31,34,33,32,34,34,39,41,47,59,62,75,69,72,85,33,36,34,35,44,41,43,52,59,60,73,67,69,82,59,61,80,59,59,76,62,62,76,67,68,77,65,80,61,66,86,63,62,78,62,63,76,68,66,78,69,69,80,64,67,90,64,67,78,62,65,78,66,80,69,67,81,70,73,90,67,70,82,66,69,80,71,70,80,66,68,82,72,77,89,68,70,69,71,84,71,71,82,65,70,81,104,109,109,110,118,118,122,122,120,120,120,118,104,104,104,104,116,115,125,127,125,128,128,123,127,127,108,111,110,104,113,121,113,126,128,127,129,129,128,127,127,122,121,104,114,121,121,127,129,128,129,129,129,128,128,117,118,118,104,112,115,112,119,120,122,123,123,122,122,114,115,115,58,66,82,56,65,72,49,57,65,47,54,62,50,54,57,54,63,79,51,65,47,56,62,47,56,60,47,51,57,54,61,73,50,58,65,48,55,61,45,55,59,45,52,59,60,71,48,58,66,50,56,63,47,55,62,46,50,60,57,61,74,51,60,66,52,58,62,48,56,52,53,64,41,40,53,34,35,48,32,32,45,33,34,47,34,36,50,34,37,40,34,33,33,34,34,33,32,33,32,34,38,38,41,49,36,40,41,37,39,41,36,39,40,37,40,42,52,55,65,53,53,60,51,51,58,48,48,56,46,48,55,66,67,76,67,69,73,64,66,74,63,65,72,64,64,72,73,72,87,57,59,71,38,39,46,32,32,35,35,31,38,85,85,92,59,59,77,35,35,41,31,29,29,30,30,32,89,94,98,62,61,81,37,33,37,30,29,30,30,30,31,86,95,98,65,65,80,37,36,42,31,29,29,29,30,31,83,87,95,73,73,83,48,47,52,36,35,40,36,35,40,68,78,94,69,81,109,67,79,110,66,78,108,103,104,105,71,80,102,70,82,112,69,81,113,66,81,111,104,104,109,72,84,102,69,82,115,67,82,115,67,81,112,104,104,111,72,82,98,71,83,113,68,82,117,66,81,117,104,104,110,69,78,95,66,80,99,67,80,111,68,82,108,104,104,104,48,53,94,46,51,106,45,51,102,45,51,102,49,51,90,43,48,86,39,46,97,38,46,96,39,46,92,44,47,84,42,47,81,38,45,83,38,45,82,38,45,85,44,45,74,43,49,75,39,46,80,39,45,78,40,46,81,41,46,71,50,55,74,47,50,75,47,50,74,48,51,73,46,50,70,77,72,67,80,71,62,82,71,63,82,73,71,77,72,78,80,72,66,83,72,60,84,72,60,83,73,62,77,75,74,81,72,60,84,71,57,84,70,57,80,70,57,75,73,68,80,73,60,82,71,59,84,70,55,77,67,57,72,69,65,77,74,66,79,69,60,75,68,55,73,65,58,72,67,65,184,122,104,184,132,104,184,132,104,184,132,104,184,132,104,184,123,104,184,132,104,184,132,104,184,132,104,184,132,104,184,132,104,184,132,104,184,132,104,184,132,104,184,132,104,158,103,95,158,104,95,158,104,95,158,104,95,158,104,95,141,103,85,141,103,85,142,103,85,142,103,86,142,103,87,68,72,83,69,72,89,69,73,92,68,71,93,70,70,89,65,68,81,65,68,85,66,67,93,68,68,94,67,71,89,58,61,77,59,59,78,63,63,85,67,64,90,69,68,86,53,53,65,57,54,69,61,58,77,62,59,87,62,65,82,48,51,61,50,53,64,55,55,75,59,59,80,61,64,82,40,42,46,32,30,37,31,32,36,33,33,43,39,41,54,44,47,51,35,39,45,38,40,46,42,44,52,45,52,61,55,61,69,56,60,70,58,61,71,60,61,72,59,61,69,70,73,82,74,80,85,75,79,90,76,80,89,72,73,79,80,82,87,81,85,90,82,86,92,81,89,90,79,82,87,47,51,78,41,45,74,40,48,71,39,49,72,44,53,73,53,57,86,47,53,87,46,51,87,48,54,86,50,54,85,56,59,100,55,56,104,53,57,102,54,58,101,55,59,97,60,64,109,59,61,114,58,60,114,58,59,109,58,61,102,63,67,112,63,64,116,61,64,115,60,62,110,61,62,104,56,52,66,54,54,57,58,54,53,65,57,53,66,60,59,55,55,67,55,54,56,58,56,55,65,58,55,72,62,59,56,56,69,59,56,59,63,60,58,72,64,61,75,66,64,57,57,70,60,57,59,67,63,62,76,68,59,78,71,66,59,60,69,63,60,62,71,66,65,78,74,68,79,75,73,34,37,53,28,29,52,28,29,53,28,28,53,32,34,54,32,33,53,28,28,38,27,27,27,27,28,35,27,29,49,37,35,53,29,28,32,27,27,27,28,27,28,29,27,43,48,46,53,30,28,29,28,28,28,28,27,27,31,28,41,54,54,54,42,42,45,35,33,37,37,34,41,39,38,49,62,71,79,66,72,76,70,74,79,71,77,83,77,83,89,56,60,73,55,62,70,58,67,74,61,69,76,67,76,82,51,57,68,49,58,66,50,57,65,53,60,67,59,66,69,49,56,63,46,54,60,47,55,61,45,59,63,53,63,67,50,59,64,46,56,63,45,57,62,46,58,63,53,61,66,65,54,47,63,52,43,62,51,43,58,48,43,57,50,45,65,52,42,63,51,40,61,50,40,57,49,41,58,49,42,63,49,40,59,49,40,57,48,39,55,48,43,56,46,40,60,49,40,56,48,40,53,45,38,53,47,40,53,45,39,56,49,51,56,48,49,52,44,42,50,44,40,53,47,42,47,51,58,52,54,61,69,72,82,89,90,98,104,104,105,45,48,55,50,53,60,66,73,84,79,83,95,103,105,107,43,47,52,50,53,62,68,74,84,81,86,93,104,108,109,44,47,56,51,55,65,70,77,84,79,86,93,104,105,104,49,54,56,56,59,66,72,76,83,85,88,97,104,103,101,55,59,117,55,61,121,53,59,121,53,59,115,54,57,103,55,59,118,49,56,122,49,55,121,49,55,115,52,53,103,55,59,116,42,52,119,43,51,119,44,51,112,49,52,103,54,59,108,41,50,117,40,50,115,42,50,107,45,50,102,55,59,101,42,50,101,39,49,101,39,49,101,46,49,102,72,75,84,79,83,91,104,104,105,104,110,114,110,116,120,69,73,85,71,75,86,104,104,105,104,109,117,111,122,127,66,75,82,69,76,86,101,104,105,104,112,118,121,126,126,72,76,81,71,78,85,97,104,104,104,110,117,119,124,126,73,76,79,74,78,81,98,104,104,104,108,116,114,118,122};

//TODO: (KL) set texton_dict back to q15_t, but need to convert single texton to q31_t in getEuclDistPatch, see getEuclDistHist for example

void initTexton(void)
{
  uint8_t i,v,h;
  volatile float idx;

  volatile float patch_spacing_h = (float) (IMAGE_WIDTH*2)/n_patches_h;

  for(i=0; i<n_patches_h; i++)
  {
	idx = (patch_spacing_h*i)+(patch_spacing_h/2);
    patch_idx_h[i] = (uint8_t) idx - (patch_size_h-1); // column numbers
  }

  volatile float patch_spacing_v = (float) (IMAGE_HEIGHT*2)/n_patches_v;

  for(i=0; i<n_patches_v; i++)
  {
	idx = (patch_spacing_v*i)+(patch_spacing_v/2);
    patch_idx_v[i] = (uint8_t) idx - (patch_size_v-1); // row numbers
  }

  for(v=0; v<n_patches_v; v++)
  {
    for(h=0; h<n_patches_h; h++)
    {
      patch_idx[v*n_patches_h + h] =  (uint16_t) patch_idx_v[v]*IMAGE_WIDTH*2 + patch_idx_h[h];
    }
  }

  n_patches = n_patches_h * n_patches_v;
}

void getTextonDistribution(uint8_t *image, q7_t *histogram)
{
  //loop the grid to create patches (for example: 10x7 patches)
  volatile uint16_t px_start;
  volatile uint16_t px;
  volatile uint8_t patch_px,patch_nr,v,h;

  // Reset histogram
  arm_fill_q7(0, histogram, n_textons);

  for(patch_nr=0; patch_nr<n_patches; patch_nr++)
  {
    px_start = patch_idx[patch_nr];
    patch_px = 0;

    // Extract patch from image
    for(v=0; v<patch_size_v; v++, px_start+=(IMAGE_WIDTH*2))
    {
      px = px_start;
      for(h=0; h<patch_size_h; h++, px+=2, patch_px+=3)
      {
        patch[patch_px]   =  (image[px+1] & 0xF8); //R first 5 bits of first byte
        patch[patch_px+1] = ((image[px+1] & 0x07) << 5) + ((image[px] & 0xE0) >> 3); //G last 3 bits of first byte and first 3 bits of second byte
        patch[patch_px+2] = ((image[px] & 0x1F) << 3); //B last 5 bits of second byte
      }
    }

    // Compute Euclidian distance between patch and all textons in dictionary and find nearest
    uint32_t dist;
    uint32_t nearest = 1294967295;
    uint8_t nearest_texton_id = 255;
    uint8_t texton_id;
    for(texton_id=0; texton_id<n_textons; texton_id++)
    {
      dist = getEuclDistPatch(patch, texton_id);
      if (dist<nearest)
      {
        nearest = dist;
        nearest_texton_id = texton_id;
      }
    }

    // Construct histogram from nearest textons
    histogram[nearest_texton_id]++;
  }

  // Update nearest texton with latest patch
  //updateTextonDictionary(bla, bla);

}

q63_t getEuclDistPatch(q15_t *patch, uint8_t texton_id)
{
  q15_t *texton_ptr;
  texton_ptr = &texton_dict[texton_id*patch_size];

  q15_t diff[patch_size];

  arm_sub_q15(texton_ptr, patch, diff, patch_size);

  q63_t sum;
  arm_dot_prod_q15(diff, diff, n_textons, &sum);

  return sum;
}

void updateTextonDictionary(int16_t patch[], uint8_t texton_id)
{

}
